---
title: "Showcase: A first Pipeline"
author: "Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


This vignette showcases the general syntax and semantic behind `mlr3pipelines`.

## An introduction to PipeOperators

In this example, we create a Äºinear Pipeline. After scaling all 
input features, we rotate our data using principal component analysis.
After transformation, we use a simple Decision Tree learner for classification.

We first create an mlr task that, which we want to transform with the pipeline. This task contains the famous iris dataset and some meta-information, such as the target variable.

```{r}
  library(mlr3)
  task = mlr_tasks$get("iris")
```

A Pipeline (or `Graph`) contains multiple PipeOperators, where each `PipeOp`
transforms the data when it flows through it. For this usecase, we require 3 transformations:
- A PipeOp that scales the data
- A PipeOp that performs PCA
- A PipeOp that contains the **Decision Tree** learner

A list of available PipeOps can be obtained from

```{r}
  library(mlr3pipelines)
  mlr_pipeops$ids()
```

First we define the required PipeOps:

```{r}
  op1 = PipeOpScale$new()
  op2 = PipeOpPCA$new()
  op3 = PipeOpLearner$new(learner = mlr_learners$get("classif.rpart"))
```

In order to get a better understanding of what the respective PipeOps do, 
we quickly look at one of them in detail:

The following slots (and more) are thus contained in each PipeOp:
- `train`: Function used to train the PipeOp.
- `predict`: Function used to predict with the PipeOp.
- `id`: Set/Get the id of the PipeOp.
- `param_set`: The set of all exposed parameters of the PipeOp.
- `param_vals`: Current hyperparameter settings.
- `is_trained`: Is the PipeOp currently trained?

We can check the properties by accessing the respective slot.

```{r}
  op3$id
  op3$is_trained
```

The `param_set` and `param_vals` are required if our PipeOp contains
hyperparameters we want to set. See [ParamSet] for a quick intro on how `ParamSet`s work.

The `train()` and `predict()` functions define the core functionality of
our PipeOp. 
In many cases, inorder to not leak information from the test set into the training set it is imperative to treat train and test data separately. For this we require a `train` function that learns the appropriate transformations from the training set and a `test` function that applies the transformation on future data.

In the case of `PipeOpLearner` this means the following:
- `train()` trains a model on its input  Task and saves the trained model to
  an additional slot, `.$state`. It returns a `list(NULL)`, as subsequent 
  operators usually do not require any output.
- `predict()` uses the model stored in `.$state` in order to predict
  the class of a new input task. It returns a [Prediction] object.
  This object contains the learner's predictions.